<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Re√ßus - Concours d'√âloquence</title>
    
    <!-- Biblioth√®ques n√©cessaires -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* === RESET === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* === CONTAINER === */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* === HEADER === */
        .header {
            background: linear-gradient(to right, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* === MAIN CONTENT === */
        .main-content {
            padding: 40px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* === FORM === */
        .form-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 18px;
        }

        .code-input {
            width: 100%;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            resize: vertical;
            min-height: 200px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .code-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .counter {
            text-align: right;
            font-size: 14px;
            color: #7f8c8d;
        }

        /* === BUTTONS === */
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        /* === RECEIPT PREVIEW === */
        .receipt-preview-container {
            position: relative;
            width: 400px;
            height: 600px;
            margin: 0 auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }

        /* === OPTIONS === */
        .options-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-item:hover {
            background: #e9ecef;
        }

        .option-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #3498db;
        }

        .option-item label {
            cursor: pointer;
            margin: 0;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        /* === DOWNLOAD SECTION === */
        .download-section {
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-radius: 15px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .download-info {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .download-icon {
            font-size: 60px;
            color: #28a745;
        }

        .file-details {
            flex: 1;
        }

        .file-details h3 {
            color: #155724;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .file-size {
            color: #0c5460;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .download-actions {
            display: flex;
            gap: 15px;
        }

        /* === LOADER === */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loader-content {
            text-align: center;
            max-width: 400px;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin: 30px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #3498db, #9b59b6);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        /* === FOOTER === */
        .footer {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
            margin-top: 40px;
        }

        /* === RECEIPT STYLES (Pour le PDF) === */
        .receipt-page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .receipt-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 15mm 20mm;
            height: 257mm;
        }

        .receipt {
            width: 85mm;
            height: 45mm;
            border: 1px solid #000;
            padding: 5mm;
            position: relative;
            font-size: 10px;
            font-family: 'Times New Roman', serif;
            page-break-inside: avoid;
            background: white;
            overflow: hidden;
        }

        .watermark-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.1;
            z-index: 0;
            background-image: url('IMG_1812.jpeg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .receipt-content {
            position: relative;
            z-index: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 2mm;
            padding-bottom: 1mm;
            border-bottom: 0.5px solid #000;
        }

        .receipt-header h3 {
            font-size: 12px;
            font-weight: bold;
            margin: 0;
            text-transform: uppercase;
        }

        .receipt-info {
            margin-bottom: 2mm;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1mm;
            font-size: 9px;
        }

        .info-label {
            font-weight: bold;
        }

        .code-display {
            text-align: center;
            margin: 2mm 0;
            padding: 2mm;
            border: 1px solid #ccc;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 11px;
            background: #f8f9fa;
        }

        .qrcode-container {
            text-align: center;
            margin: 2mm 0;
        }

        .signature-container {
            text-align: right;
            margin-top: auto;
            padding-top: 2mm;
            border-top: 0.5px solid #000;
        }

        .signature-img {
            height: 12mm;
            display: block;
            margin-left: auto;
            opacity: 0.8;
        }

        .receipt-number {
            position: absolute;
            top: 1mm;
            right: 1mm;
            font-size: 8px;
            color: #666;
            background: white;
            padding: 1mm 2mm;
            border-radius: 2mm;
            border: 0.5px solid #ddd;
        }

        /* === NOTIFICATION === */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification i {
            font-size: 24px;
        }

        .notification-success i { color: #28a745; }
        .notification-error i { color: #dc3545; }
        .notification-info i { color: #17a2b8; }

        /* === RESPONSIVE === */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .receipt-page, .receipt-page * {
                visibility: visible;
            }
            
            .receipt-page {
                position: absolute;
                left: 0;
                top: 0;
                box-shadow: none;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üé§ G√©n√©rateur de Re√ßus de Paiement</h1>
            <p>Concours d'√âloquence 2024 ‚Ä¢ 10 re√ßus par page A4</p>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Column -->
            <div>
                <!-- Form Section -->
                <div class="form-section">
                    <div class="form-group">
                        <label for="codeInput">üìù Codes de vote (un par ligne)</label>
                        <textarea 
                            id="codeInput" 
                            class="code-input" 
                            placeholder="Entrez les codes, un par ligne :&#10;ELOQ-2024-001&#10;ELOQ-2024-002&#10;ELOQ-2024-003&#10;..."
                            rows="8"
                        >ELOQ-2024-001
ELOQ-2024-002
ELOQ-2024-003
ELOQ-2024-004
ELOQ-2024-005
ELOQ-2024-006
ELOQ-2024-007
ELOQ-2024-008
ELOQ-2024-009
ELOQ-2024-010</textarea>
                        <div class="counter">
                            <span id="codeCount">10</span> codes saisis
                        </div>
                    </div>

                    <!-- Options -->
                    <div class="form-group">
                        <label>‚öôÔ∏è Options de g√©n√©ration</label>
                        <div class="option-item">
                            <input type="checkbox" id="optionWatermark" checked>
                            <label for="optionWatermark">
                                <div style="width: 20px; height: 20px; background: #3498db; opacity: 0.3; margin-right: 10px;"></div>
                                Appliquer le filigrane (IMG_1812.jpeg)
                            </label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="optionSignature" checked>
                            <label for="optionSignature">
                                <div style="width: 20px; height: 20px; border-bottom: 2px solid #000; margin-right: 10px;"></div>
                                Ajouter la signature (Times_New_Roman.png)
                            </label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="optionQRCode" checked>
                            <label for="optionQRCode">
                                <div style="width: 20px; height: 20px; border: 2px solid #000; margin-right: 10px; position: relative;">
                                    <div style="position: absolute; width: 12px; height: 12px; background: #000; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                                </div>
                                Inclure les codes QR
                            </label>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="button-group">
                        <button class="btn btn-primary" id="generateBtn">
                            üöÄ G√©n√©rer les Re√ßus PDF
                        </button>
                        <button class="btn btn-secondary" id="previewBtn">
                            üëÅÔ∏è Aper√ßu Rapide
                        </button>
                        <button class="btn btn-secondary" id="clearBtn">
                            üóëÔ∏è Effacer Tout
                        </button>
                        <button class="btn btn-success" id="exampleBtn">
                            üìã Charger Exemple
                        </button>
                    </div>
                </div>

                <!-- Download Section -->
                <div class="download-section" id="downloadSection">
                    <div class="download-info">
                        <div class="download-icon">‚úÖ</div>
                        <div class="file-details">
                            <h3>Re√ßus g√©n√©r√©s avec succ√®s !</h3>
                            <p id="downloadMessage">10 re√ßus pr√™ts √† t√©l√©charger</p>
                            <div class="file-size">
                                <span>üìÑ</span>
                                <span id="fileName">receipts.pdf</span>
                                ‚Ä¢
                                <span id="fileSize">~250 KB</span>
                            </div>
                        </div>
                        <div class="download-actions">
                            <button class="btn btn-primary" id="downloadPDFBtn">
                                üì• T√©l√©charger PDF
                            </button>
                            <button class="btn btn-secondary" id="printBtn">
                                üñ®Ô∏è Imprimer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="options-section">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">üìä Informations</h3>
                
                <div style="background: #e8f4fc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #3498db; margin-bottom: 10px;">üìù Format des re√ßus</h4>
                    <ul style="padding-left: 20px; color: #2c3e50;">
                        <li>10 re√ßus par page A4</li>
                        <li>2 colonnes √ó 5 lignes</li>
                        <li>Taille : 85mm √ó 45mm</li>
                        <li>Optimis√© pour impression</li>
                    </ul>
                </div>

                <div style="background: #f0f8f0; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #27ae60; margin-bottom: 10px;">üîí S√©curit√© int√©gr√©e</h4>
                    <ul style="padding-left: 20px; color: #2c3e50;">
                        <li>Filigrane unique par re√ßu</li>
                        <li>Signature num√©rique</li>
                        <li>Code QR de v√©rification</li>
                        <li>Num√©ro de s√©rie unique</li>
                    </ul>
                </div>

                <div style="background: #fff8e1; padding: 20px; border-radius: 8px;">
                    <h4 style="color: #f39c12; margin-bottom: 10px;">üí° Conseils</h4>
                    <ul style="padding-left: 20px; color: #2c3e50;">
                        <li>Utilisez du papier A4 standard</li>
                        <li>Imprimez en haute qualit√©</li>
                        <li>Conservez une copie num√©rique</li>
                        <li>V√©rifiez avant distribution</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>¬© 2024 Concours d'√âloquence ‚Ä¢ Tous droits r√©serv√©s</p>
            <p style="margin-top: 10px; opacity: 0.8; font-size: 14px;">
                G√©n√©rateur officiel de re√ßus ‚Ä¢ Version 3.0
            </p>
        </div>
    </div>

    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="loader-content">
            <div class="spinner"></div>
            <h3>G√©n√©ration en cours...</h3>
            <p>Cr√©ation des re√ßus PDF</p>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <p id="loaderStatus">Initialisation</p>
        </div>
    </div>

    <!-- Hidden receipt container for PDF generation -->
    <div id="pdfContainer" style="position: absolute; left: -9999px; top: -9999px; width: 210mm;"></div>

    <script>
        // ============ VARIABLES GLOBALES ============
        let codes = [];
        let pdfBlob = null;
        let generatedPDF = null;

        // ============ INITIALISATION ============
        document.addEventListener('DOMContentLoaded', function() {
            updateCodeCount();
            loadFromLocalStorage();
            
            // √âv√©nements
            document.getElementById('codeInput').addEventListener('input', updateCodeCount);
            document.getElementById('generateBtn').addEventListener('click', generateReceiptsPDF);
            document.getElementById('previewBtn').addEventListener('click', showQuickPreview);
            document.getElementById('clearBtn').addEventListener('click', clearAll);
            document.getElementById('exampleBtn').addEventListener('click', loadExample);
            document.getElementById('downloadPDFBtn').addEventListener('click', downloadPDF);
            document.getElementById('printBtn').addEventListener('click', printPDF);
            
            // Raccourcis clavier
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            console.log('‚úÖ G√©n√©rateur de re√ßus initialis√©');
        });

        // ============ FONCTIONS PRINCIPALES ============

        // Mettre √† jour le compteur de codes
        function updateCodeCount() {
            const text = document.getElementById('codeInput').value.trim();
            codes = text.split('\n')
                .map(code => code.trim())
                .filter(code => code.length > 0);
            
            document.getElementById('codeCount').textContent = codes.length;
            saveToLocalStorage();
        }

        // G√©n√©rer les re√ßus PDF
        async function generateReceiptsPDF() {
            if (codes.length === 0) {
                showNotification('‚ùå Veuillez entrer au moins un code', 'error');
                return;
            }

            showLoader('Pr√©paration des re√ßus...');
            
            try {
                // Options
                const options = {
                    watermark: document.getElementById('optionWatermark').checked,
                    signature: document.getElementById('optionSignature').checked,
                    qrcode: document.getElementById('optionQRCode').checked
                };

                // G√©n√©rer le PDF
                const pdf = await createPDF(codes, options);
                
                // Sauvegarder le PDF
                pdfBlob = pdf.output('blob');
                generatedPDF = pdf;
                
                // Mettre √† jour l'interface
                updateDownloadSection();
                showDownloadSection();
                
                hideLoader();
                showNotification(`‚úÖ ${codes.length} re√ßu(s) g√©n√©r√©(s) avec succ√®s`, 'success');
                
            } catch (error) {
                console.error('Erreur g√©n√©ration PDF:', error);
                hideLoader();
                showNotification('‚ùå Erreur lors de la g√©n√©ration', 'error');
            }
        }

        // Cr√©er le PDF
        async function createPDF(codes, options) {
            return new Promise(async (resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const pageWidth = 210;
                    const pageHeight = 297;
                    const margin = 20;
                    const receiptWidth = 85;
                    const receiptHeight = 45;
                    const cols = 2;
                    const rows = 5;
                    const horizontalGap = (pageWidth - 2 * margin - cols * receiptWidth) / (cols - 1);
                    const verticalGap = (pageHeight - 2 * margin - rows * receiptHeight) / (rows - 1);

                    let currentPage = 0;
                    let receiptIndex = 0;

                    // G√©n√©rer les re√ßus page par page
                    for (let page = 0; page < Math.ceil(codes.length / 10); page++) {
                        if (page > 0) {
                            pdf.addPage();
                        }

                        // D√©finir la police
                        pdf.setFont('helvetica');
                        pdf.setFontSize(8);

                        // G√©n√©rer 10 re√ßus par page
                        for (let row = 0; row < rows; row++) {
                            for (let col = 0; col < cols; col++) {
                                if (receiptIndex >= codes.length) break;

                                const x = margin + col * (receiptWidth + horizontalGap);
                                const y = margin + row * (receiptHeight + verticalGap);
                                const code = codes[receiptIndex];
                                
                                // Dessiner le cadre du re√ßu
                                pdf.setDrawColor(0, 0, 0);
                                pdf.setLineWidth(0.5);
                                pdf.rect(x, y, receiptWidth, receiptHeight);

                                // Ajouter le filigrane
                                if (options.watermark) {
                                    try {
                                        // Simuler un filigrane avec du texte
                                        pdf.setTextColor(200, 200, 200);
                                        pdf.setFontSize(40);
                                        pdf.text('√âLOQUENCE', x + receiptWidth/2, y + receiptHeight/2, { align: 'center', angle: 45 });
                                        pdf.setTextColor(0, 0, 0);
                                        pdf.setFontSize(8);
                                    } catch (e) {
                                        console.warn('Filigrane non charg√©');
                                    }
                                }

                                // En-t√™te
                                pdf.setFontSize(10);
                                pdf.setFont('helvetica', 'bold');
                                pdf.text('RE√áU DE PAIEMENT', x + receiptWidth/2, y + 5, { align: 'center' });
                                pdf.setFont('helvetica', 'normal');
                                pdf.text('Concours d\'√âloquence 2024', x + receiptWidth/2, y + 8, { align: 'center' });
                                pdf.setFontSize(8);

                                // Ligne de s√©paration
                                pdf.line(x + 5, y + 10, x + receiptWidth - 5, y + 10);

                                // Informations
                                const now = new Date();
                                const dateStr = now.toLocaleDateString('fr-FR');
                                const timeStr = now.toLocaleTimeString('fr-FR').slice(0, 5);
                                const ref = `REF-${now.getFullYear()}-${String(receiptIndex + 1).padStart(4, '0')}`;

                                pdf.text(`Date: ${dateStr}`, x + 5, y + 15);
                                pdf.text(`Heure: ${timeStr}`, x + 5, y + 18);
                                pdf.text(`R√©f: ${ref}`, x + 5, y + 21);
                                pdf.text(`Montant: 50,00 ‚Ç¨`, x + 5, y + 24);

                                // Code de vote
                                pdf.setFont('courier', 'bold');
                                pdf.setFontSize(10);
                                pdf.text('CODE DE VOTE:', x + receiptWidth/2, y + 30, { align: 'center' });
                                pdf.setFontSize(12);
                                pdf.setTextColor(220, 53, 69);
                                pdf.text(code, x + receiptWidth/2, y + 35, { align: 'center' });
                                pdf.setTextColor(0, 0, 0);
                                pdf.setFont('helvetica', 'normal');
                                pdf.setFontSize(8);

                                // QR Code (simul√©)
                                if (options.qrcode) {
                                    pdf.setDrawColor(100, 100, 100);
                                    pdf.rect(x + receiptWidth - 20, y + 28, 15, 15);
                                    pdf.text('QR', x + receiptWidth - 12.5, y + 35.5, { align: 'center' });
                                }

                                // Signature
                                if (options.signature) {
                                    pdf.text('Le Pr√©sident du Jury', x + receiptWidth - 40, y + receiptHeight - 5);
                                    pdf.line(x + receiptWidth - 40, y + receiptHeight - 6, x + receiptWidth - 10, y + receiptHeight - 6);
                                }

                                // Num√©ro de s√©quence
                                pdf.setFontSize(6);
                                pdf.setTextColor(100, 100, 100);
                                pdf.text(`${receiptIndex + 1}/${codes.length}`, x + receiptWidth - 8, y + 4);
                                pdf.setTextColor(0, 0, 0);

                                receiptIndex++;
                            }
                        }

                        // Num√©ro de page
                        pdf.setFontSize(10);
                        pdf.text(`Page ${page + 1}`, pageWidth/2, pageHeight - 10, { align: 'center' });

                        updateProgress(Math.min((receiptIndex / codes.length) * 100, 90));
                    }

                    updateProgress(100);
                    resolve(pdf);

                } catch (error) {
                    reject(error);
                }
            });
        }

        // Mettre √† jour la section de t√©l√©chargement
        function updateDownloadSection() {
            const fileSize = pdfBlob ? Math.round(pdfBlob.size / 1024) : 0;
            const pageCount = Math.ceil(codes.length / 10);
            
            document.getElementById('downloadMessage').textContent = 
                `${codes.length} re√ßu(s) ‚Ä¢ ${pageCount} page(s) A4`;
            document.getElementById('fileName').textContent = 
                `recus_eloquence_${new Date().toISOString().slice(0,10)}.pdf`;
            document.getElementById('fileSize').textContent = `${fileSize} KB`;
        }

        // T√©l√©charger le PDF
        function downloadPDF() {
            if (!generatedPDF) {
                showNotification('‚ùå Aucun PDF √† t√©l√©charger', 'error');
                return;
            }

            const filename = `recus_concours_eloquence_${new Date().toISOString().slice(0,19).replace(/[:]/g, '-')}.pdf`;
            generatedPDF.save(filename);
            showNotification('üì• T√©l√©chargement d√©marr√©', 'success');
        }

        // Imprimer le PDF
        function printPDF() {
            if (!generatedPDF) {
                showNotification('‚ùå Aucun PDF √† imprimer', 'error');
                return;
            }

            // Cr√©er une nouvelle fen√™tre pour l'impression
            const printWindow = window.open('', '_blank');
            const pdfDataUri = generatedPDF.output('datauristring');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Impression des Re√ßus</title>
                    <style>
                        body { margin: 0; padding: 0; }
                        iframe { width: 100%; height: 100vh; border: none; }
                    </style>
                </head>
                <body>
                    <iframe src="${pdfDataUri}"></iframe>
                    <script>
                        window.onload = function() {
                            setTimeout(function() {
                                document.querySelector('iframe').contentWindow.print();
                            }, 1000);
                        };
                    <\/script>
                </body>
                </html>
            `);
        }

        // ============ FONCTIONS UTILITAIRES ============

        // Afficher l'aper√ßu rapide
        function showQuickPreview() {
            if (codes.length === 0) {
                showNotification('‚ùå Veuillez entrer des codes', 'error');
                return;
            }

            // Cr√©er un aper√ßu du premier re√ßu
            const previewWindow = window.open('', '_blank', 'width=600,height=800');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Aper√ßu Re√ßu</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .receipt { 
                            width: 300px; 
                            border: 2px solid #000; 
                            padding: 20px; 
                            margin: 0 auto;
                            position: relative;
                        }
                        .watermark { 
                            position: absolute; 
                            top: 0; left: 0; 
                            width: 100%; height: 100%; 
                            opacity: 0.1; 
                            background: #ccc; 
                            z-index: 0; 
                        }
                        .content { position: relative; z-index: 1; }
                        h2 { text-align: center; margin: 0 0 10px 0; }
                        .code { 
                            text-align: center; 
                            font-size: 24px; 
                            font-weight: bold; 
                            color: #c00; 
                            margin: 20px 0; 
                            font-family: monospace;
                        }
                    </style>
                </head>
                <body>
                    <h1>Aper√ßu du Re√ßu</h1>
                    <div class="receipt">
                        <div class="watermark"></div>
                        <div class="content">
                            <h2>RE√áU DE PAIEMENT</h2>
                            <p><strong>Concours d'√âloquence 2024</strong></p>
                            <p>Date: ${new Date().toLocaleDateString('fr-FR')}</p>
                            <p>Code: <span class="code">${codes[0]}</span></p>
                            <p>Montant: 50,00 ‚Ç¨</p>
                            <div style="text-align: right; margin-top: 30px;">
                                <div style="border-top: 1px solid #000; width: 150px; margin-left: auto;"></div>
                                <p>Signature</p>
                            </div>
                        </div>
                    </div>
                    <p style="text-align: center; margin-top: 20px; color: #666;">
                        Ceci est un aper√ßu. Le PDF final contiendra ${codes.length} re√ßu(s).
                    </p>
                </body>
                </html>
            `);
        }

        // Effacer tout
        function clearAll() {
            if (codes.length > 0 && confirm('√ätes-vous s√ªr de vouloir tout effacer ?')) {
                document.getElementById('codeInput').value = '';
                codes = [];
                updateCodeCount();
                document.getElementById('downloadSection').style.display = 'none';
                showNotification('üóëÔ∏è Tous les codes ont √©t√© effac√©s', 'info');
            }
        }

        // Charger un exemple
        function loadExample() {
            const example = [];
            for (let i = 1; i <= 12; i++) {
                example.push(`ELOQ-2024-${String(i).padStart(3, '0')}`);
            }
            document.getElementById('codeInput').value = example.join('\n');
            updateCodeCount();
            showNotification('üìã Exemple charg√© (12 codes)', 'success');
        }

        // Afficher la section de t√©l√©chargement
        function showDownloadSection() {
            document.getElementById('downloadSection').style.display = 'block';
            document.getElementById('downloadSection').scrollIntoView({ behavior: 'smooth' });
        }

        // ============ GESTION DU LOADER ============

        function showLoader(message) {
            document.getElementById('loaderStatus').textContent = message;
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('progressBar').style.width = '0%';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('loaderStatus').textContent = 
                `G√©n√©ration... ${Math.round(percent)}%`;
        }

        // ============ NOTIFICATIONS ============

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span style="font-size: 24px;">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background:none; border:none; font-size:24px; cursor:pointer; margin-left:auto;">√ó</button>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // ============ LOCAL STORAGE ============

        function saveToLocalStorage() {
            localStorage.setItem('eloquenceCodes', JSON.stringify(codes));
            localStorage.setItem('eloquenceOptions', JSON.stringify({
                watermark: document.getElementById('optionWatermark').checked,
                signature: document.getElementById('optionSignature').checked,
                qrcode: document.getElementById('optionQRCode').checked
            }));
        }

        function loadFromLocalStorage() {
            const savedCodes = localStorage.getItem('eloquenceCodes');
            const savedOptions = localStorage.getItem('eloquenceOptions');
            
            if (savedCodes) {
                codes = JSON.parse(savedCodes);
                if (codes.length > 0) {
                    document.getElementById('codeInput').value = codes.join('\n');
                    updateCodeCount();
                }
            }
            
            if (savedOptions) {
                const options = JSON.parse(savedOptions);
                document.getElementById('optionWatermark').checked = options.watermark;
                document.getElementById('optionSignature').checked = options.signature;
                document.getElementById('optionQRCode').checked = options.qrcode;
            }
        }

        // ============ RACCOURCIS CLAVIER ============

        function handleKeyboardShortcuts(e) {
            // Ctrl+Enter : G√©n√©rer
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                generateReceiptsPDF();
            }
            
            // Ctrl+E : Exemple
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                loadExample();
            }
            
            // Ctrl+D : T√©l√©charger
            if (e.ctrlKey && e.key === 'd' && generatedPDF) {
                e.preventDefault();
                downloadPDF();
            }
            
            // Ctrl+P : Imprimer
            if (e.ctrlKey && e.key === 'p' && generatedPDF) {
                e.preventDefault();
                printPDF();
            }
        }

        // ============ FONCTIONS EXPORT√âES ============
        window.downloadPDF = downloadPDF;
        window.printPDF = printPDF;
    </script>
</body>
</html>